---
title: "筆記: Network"
date: 2025-10-02 00:00:00 +0800
categories: [Careers, Notes]
tags: [Tech, Network]
---

# TCP + TLS 完整封包流程

---

## 🔹 TLS 1.2 （Full Handshake，需要 2 RTT for TLS）

**TCP 建立**
- **A.** Client → Server : `SYN`
- **B.** Server → Client : `SYN+ACK`
- **C.** Client → Server : `ACK`

**TLS 握手**
- **D.** Client → Server : `ClientHello`  
  - 支援的 Cipher Suites  
  - 支援的 TLS 版本  
  - Client Random  
- **E.** Server → Client : `ServerHello + Certificate + ServerKeyExchange + ServerHelloDone`  
  - 選定 Cipher Suite / TLS 版本  
  - Server Random  
  - Server Certificate (公鑰)  
  - Server KeyExchange (ECDHE 公鑰)  
- **F.** Client → Server : `ClientKeyExchange + ChangeCipherSpec + Finished`  
  - PreMasterSecret 或 ECDHE 公鑰  
  - ChangeCipherSpec + Finished → client 進入加密狀態  
- **G.** Server → Client : `ChangeCipherSpec + Finished`  
  - server 進入加密狀態

**應用層**
- **H.** Client → Server : `Encrypted Application Data (HTTP GET …)`
- **I.** Server → Client : `Encrypted Application Data (HTTP Response …)`

➡️ **總共 3 RTT (TCP 1 + TLS 2)**

---

## 🔹 TLS 1.3 （Full Handshake，需要 1 RTT for TLS）

**TCP 建立**
- **A.** Client → Server : `SYN`
- **B.** Server → Client : `SYN+ACK`
- **C.** Client → Server : `ACK`

**TLS 握手**
- **D.** Client → Server : `ClientHello (+ KeyShare)`  
  - Client Random  
  - Cipher Suites  
  - 支援版本 (TLS 1.3)  
  - KeyShare (ECDHE 公鑰)  
- **E.** Server → Client : `ServerHello + EncryptedExtensions + Certificate + CertificateVerify + Finished`  
  - Server Random  
  - Server KeyShare (ECDHE 公鑰)  
  - Server Certificate  
  - CertificateVerify  
  - Finished (server 已完成握手)  
- **F.** Client → Server : `Finished`  
  - Client 也完成握手，進入加密狀態  

**應用層**
- **G.** Client → Server : `Encrypted Application Data (HTTP GET …)`
- **H.** Server → Client : `Encrypted Application Data (HTTP Response …)`

➡️ **總共 2 RTT (TCP 1 + TLS 1)**

---

## 🔹 TLS 1.3 with 0-RTT (Session Resumption)

**TCP 建立 + TLS**
- **A.** Client → Server : `SYN + ClientHello (+ KeyShare) + 0-RTT Application Data (HTTP GET …)`  
- **B.** Server → Client : `SYN+ACK + ServerHello (+ 可選 early response)`  
- **C.** Client → Server : `ACK`  
- **D.** Server → Client : `EncryptedExtensions + Certificate + Finished + Encrypted Application Data (HTTP Response …)`  
- **E.** Client → Server : `Finished`

➡️ **只需 1 RTT 就能拿到第一個 Response**  
（0-RTT 資料缺乏前向安全性，可能被重放攻擊）

---

# 🔹 差異比較表

| 協議版本       | TLS 握手所需 RTT | 可以省略 / 疊合的訊息 |
|----------------|------------------|------------------------|
| TLS 1.2        | 2 RTT            | 無（每段獨立）        |
| TLS 1.3        | 1 RTT            | ServerHello + Certificate + Finished 合併；ClientKeyExchange & Finished 合併 |
| TLS 1.3 0-RTT  | 0 RTT (應用層) + 1 RTT（確認完成） | ClientHello 與 Application Data 疊合；ServerHello 與 Application Response 疊合 |
