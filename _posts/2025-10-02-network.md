---
title: "筆記: Network"
date: 2025-10-02 00:00:00 +0800
categories: [Careers, Notes]
tags: [Tech, Network]
---

# TCP + TLS 完整封包流程

---

## 🔹 TLS 1.2 （Full Handshake，需要 2 RTT for TLS）

**TCP 建立**
- **A.** Client → Server : `SYN`
- **B.** Server → Client : `SYN+ACK`
- **C.** Client → Server : `ACK`

**TLS 握手**
- **D.** Client → Server : `ClientHello`  
  - 支援的 Cipher Suites  
  - 支援的 TLS 版本  
  - Client Random  
- **E.** Server → Client : `ServerHello + Certificate + ServerKeyExchange + ServerHelloDone`  
  - 選定 Cipher Suite / TLS 版本  
  - Server Random  
  - Server Certificate (公鑰)  
  - Server KeyExchange (ECDHE 公鑰)  
- **F.** Client → Server : `ClientKeyExchange + ChangeCipherSpec + Finished`  
  - PreMasterSecret 或 ECDHE 公鑰  
  - ChangeCipherSpec + Finished → client 進入加密狀態  
- **G.** Server → Client : `ChangeCipherSpec + Finished`  
  - server 進入加密狀態

**應用層**
- **H.** Client → Server : `Encrypted Application Data (HTTP GET …)`
- **I.** Server → Client : `Encrypted Application Data (HTTP Response …)`

➡️ **總共 3 RTT (TCP 1 + TLS 2)**

---

## 🔹 TLS 1.3 （Full Handshake，需要 1 RTT for TLS）

**TCP 建立**
- **A.** Client → Server : `SYN`
- **B.** Server → Client : `SYN+ACK`
- **C.** Client → Server : `ACK`

**TLS 握手**
- **D.** Client → Server : `ClientHello (+ KeyShare)`  
  - Client Random  
  - Cipher Suites  
  - 支援版本 (TLS 1.3)  
  - KeyShare (ECDHE 公鑰)  
- **E.** Server → Client : `ServerHello + EncryptedExtensions + Certificate + CertificateVerify + Finished`  
  - Server Random  
  - Server KeyShare (ECDHE 公鑰)  
  - Server Certificate  
  - CertificateVerify  
  - Finished (server 已完成握手)  
- **F.** Client → Server : `Finished`  
  - Client 也完成握手，進入加密狀態  

**應用層**
- **G.** Client → Server : `Encrypted Application Data (HTTP GET …)`
- **H.** Server → Client : `Encrypted Application Data (HTTP Response …)`

➡️ **總共 2 RTT (TCP 1 + TLS 1)**

---

## 🔹 TLS 1.3 with 0-RTT (Session Resumption)

**TCP 建立 + TLS**
- **A.** Client → Server : `SYN + ClientHello (+ KeyShare) + 0-RTT Application Data (HTTP GET …)`  
- **B.** Server → Client : `SYN+ACK + ServerHello (+ 可選 early response)`  
- **C.** Client → Server : `ACK`  
- **D.** Server → Client : `EncryptedExtensions + Certificate + Finished + Encrypted Application Data (HTTP Response …)`  
- **E.** Client → Server : `Finished`

➡️ **只需 1 RTT 就能拿到第一個 Response**  
（0-RTT 資料缺乏前向安全性，可能被重放攻擊）

---

# 🔹 差異比較表

| 協議版本       | TLS 握手所需 RTT | 可以省略 / 疊合的訊息 |
|----------------|------------------|------------------------|
| TLS 1.2        | 2 RTT            | 無（每段獨立）        |
| TLS 1.3        | 1 RTT            | ServerHello + Certificate + Finished 合併；ClientKeyExchange & Finished 合併 |
| TLS 1.3 0-RTT  | 0 RTT (應用層) + 1 RTT（確認完成） | ClientHello 與 Application Data 疊合；ServerHello 與 Application Response 疊合 |

---

# TLS 握手與加密流程解析

## 1️⃣ 非對稱加密：公鑰與私鑰

TLS 握手初期使用 **非對稱加密**，目的：
1. 身份驗證：Server 透過 Certificate (公鑰簽章) 讓 Client 驗證
2. 安全交換對稱密鑰：避免中間人竊聽

### 對應流程
- **E. Server → Client : Certificate + ServerKeyExchange**
  - Server 傳公鑰 (Certificate)
  - ServerKeyExchange 提供 ECDHE 公鑰
- **F. Client → Server : ClientKeyExchange**
  - Client 使用 Server 公鑰 / ECDHE 計算 PreMasterSecret
  - Server 用私鑰計算同樣共享密鑰

> 核心：非對稱只用於安全交換對稱密鑰

---

## 2️⃣ 產生對稱密鑰 (Session Key)

雙方使用：
- Client Random (D)
- Server Random (E)
- PreMasterSecret (F)

透過 **Key Derivation Function (KDF)** 計算：
- Master Secret → Session Key
- Session Key 用於對稱加密（AES, ChaCha20…）

> 核心：安全交換小秘密 → 生成大秘密 → 對稱高速加密

---

## 3️⃣ 握手後切換對稱加密

- **F. Client → Server : ChangeCipherSpec + Finished**
  - Client 通知 Server 從此使用對稱密鑰加密
- **G. Server → Client : ChangeCipherSpec + Finished**
  - Server 同步切換到對稱密鑰

> 現在雙方握到相同的 Session Key，開始高速對稱加密通訊

---

## 4️⃣ 應用層資料加解密

- **H/I. Encrypted Application Data**
  - 對稱加密套用於 HTTP 資料
  - Cipher Suite 決定加密算法，例如：
    - AES-GCM / ChaCha20-Poly1305 (加密 + 完整性驗證)
  - Client/Server 使用 Session Key 做加解密
  - 中間人無法解密資料

---

## 🔹 總結流程對應表

| 流程編號 | 功能                       | 加密類型       | 訊息內容                                     |
|-----------|---------------------------|----------------|---------------------------------------------|
| D ClientHello | 握手開始                 | 無             | Cipher Suite, TLS 版本, Client Random       |
| E ServerHello + Certificate + ServerKeyExchange | 握手回應、身份驗證 | 非對稱         | Server Random, Server 公鑰 / KeyExchange   |
| F ClientKeyExchange + ChangeCipherSpec + Finished | 生成共享密鑰、切換對稱加密 | 非對稱 → 對稱 | PreMasterSecret → Session Key, 換對稱密鑰 |
| G ChangeCipherSpec + Finished | 切換加密              | 對稱           | Session Key 開始使用                         |
| H/I Application Data | 應用層資料加密         | 對稱           | HTTP GET / Response，加密後傳輸             |

**IP Header**

| 欄位                  | 位元     | 功能                       | Linux / C/C++ 對應       |
| --------------------- | ------- | -------------------------- | ---------------------- |
| Version               | 0-3     | IPv4=4, IPv6=6             | `iph->version`         |
| IHL (Header Length)   | 4-7     | IP header 長度（32-bit words）| `iph->ihl`             |
| Type of Service (TOS) | 8-15    | QoS / DSCP                 | `iph->tos`             |
| Total Length          | 16-31   | IP packet 長度（含 header）     | `iph->tot_len`         |
| Identification        | 32-47   | 封包重組 ID                    | `iph->id`              |
| Flags                 | 48-50   | DF / MF                    | `iph->frag_off` (位元操作) |
| Fragment Offset       | 51-63   | 分片偏移                       | `iph->frag_off`        |
| TTL                   | 64-71   | Time To Live               | `iph->ttl`             |
| Protocol              | 72-79   | TCP=6, UDP=17              | `iph->protocol`        |
| Header Checksum       | 80-95   | 檢查 IP header               | `iph->check`           |
| Source IP             | 96-127  | 封包來源 IP                    | `iph->saddr`           |
| Destination IP        | 128-159 | 封包目的 IP                    | `iph->daddr`           |

**TCP Header**

| 欄位                     | 位元     | 功能                      | Linux / C/C++ 對應 |
| ------------------------ | ------- | --------------------------- | ----------------- | 
| Source Port              | 0-15    | 封包來源 port                   | `tcph->source` |
| Destination Port         | 16-31   | 封包目的 port                   | `tcph->dest` |
| Sequence Number          | 32-63   | 封包序號                        | `tcph->seq` |
| Acknowledgment Number    | 64-95   | ACK 序號（收到資料確認）              | `tcph->ack_seq` |
| Data Offset              | 96-99   | TCP header 長度（32-bit words） | `tcph->doff` |
| Reserved                 | 100-103 | 保留，通常為 0                    | `tcph->res1` / bitfield |
| **Flags / Control Bits** | 104-111 | 6-9 bits 常用                 | `tcph->fin/syn/rst/psh/ack/urg` 或 `tcph->th_flags |
| FIN                      | 104     | 結束連線                        | `TH_FIN` |
| SYN                      | 105     | 建立連線                        | `TH_SYN` |
| RST                      | 106     | 重置連線                        | `TH_RST` |
| PSH                      | 107     | Push                        | `TH_PUSH` |
| ACK                      | 108     | 確認號有效                       | `TH_ACK` |
| URG                      | 109     | Urgent pointer 有效           | `TH_URG` |
| ECE                      | 110     | ECN Echo                    | `TH_ECE` |
| CWR                      | 111     | Congestion Window Reduced   | `TH_CWR` |
| NS                       | 112     | ECN nonce                   | `TH_NS` |
| Window Size              | 112-127 | Flow control                | `tcph->window` |
| Checksum                 | 128-143 | TCP 檢查碼                     | `tcph->check` |
| Urgent Pointer           | 144-159 | 指示 urgent data              | `tcph->urg_ptr` |
| Options                  | 160+    | 可變長，32-bit 對齊               | `tcph->options` (手動處理) |
