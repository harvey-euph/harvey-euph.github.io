---
title: "ç­†è¨˜: Network"
date: 2025-10-02 00:00:00 +0800
categories: [Careers, Notes]
tags: [Tech, Network]
---

# TCP + TLS å®Œæ•´å°åŒ…æµç¨‹

---

## ğŸ”¹ TLS 1.2 ï¼ˆFull Handshakeï¼Œéœ€è¦ 2 RTT for TLSï¼‰

**TCP å»ºç«‹**
- **A.** Client â†’ Server : `SYN`
- **B.** Server â†’ Client : `SYN+ACK`
- **C.** Client â†’ Server : `ACK`

**TLS æ¡æ‰‹**
- **D.** Client â†’ Server : `ClientHello`  
  - æ”¯æ´çš„ Cipher Suites  
  - æ”¯æ´çš„ TLS ç‰ˆæœ¬  
  - Client Random  
- **E.** Server â†’ Client : `ServerHello + Certificate + ServerKeyExchange + ServerHelloDone`  
  - é¸å®š Cipher Suite / TLS ç‰ˆæœ¬  
  - Server Random  
  - Server Certificate (å…¬é‘°)  
  - Server KeyExchange (ECDHE å…¬é‘°)  
- **F.** Client â†’ Server : `ClientKeyExchange + ChangeCipherSpec + Finished`  
  - PreMasterSecret æˆ– ECDHE å…¬é‘°  
  - ChangeCipherSpec + Finished â†’ client é€²å…¥åŠ å¯†ç‹€æ…‹  
- **G.** Server â†’ Client : `ChangeCipherSpec + Finished`  
  - server é€²å…¥åŠ å¯†ç‹€æ…‹

**æ‡‰ç”¨å±¤**
- **H.** Client â†’ Server : `Encrypted Application Data (HTTP GET â€¦)`
- **I.** Server â†’ Client : `Encrypted Application Data (HTTP Response â€¦)`

â¡ï¸ **ç¸½å…± 3 RTT (TCP 1 + TLS 2)**

---

## ğŸ”¹ TLS 1.3 ï¼ˆFull Handshakeï¼Œéœ€è¦ 1 RTT for TLSï¼‰

**TCP å»ºç«‹**
- **A.** Client â†’ Server : `SYN`
- **B.** Server â†’ Client : `SYN+ACK`
- **C.** Client â†’ Server : `ACK`

**TLS æ¡æ‰‹**
- **D.** Client â†’ Server : `ClientHello (+ KeyShare)`  
  - Client Random  
  - Cipher Suites  
  - æ”¯æ´ç‰ˆæœ¬ (TLS 1.3)  
  - KeyShare (ECDHE å…¬é‘°)  
- **E.** Server â†’ Client : `ServerHello + EncryptedExtensions + Certificate + CertificateVerify + Finished`  
  - Server Random  
  - Server KeyShare (ECDHE å…¬é‘°)  
  - Server Certificate  
  - CertificateVerify  
  - Finished (server å·²å®Œæˆæ¡æ‰‹)  
- **F.** Client â†’ Server : `Finished`  
  - Client ä¹Ÿå®Œæˆæ¡æ‰‹ï¼Œé€²å…¥åŠ å¯†ç‹€æ…‹  

**æ‡‰ç”¨å±¤**
- **G.** Client â†’ Server : `Encrypted Application Data (HTTP GET â€¦)`
- **H.** Server â†’ Client : `Encrypted Application Data (HTTP Response â€¦)`

â¡ï¸ **ç¸½å…± 2 RTT (TCP 1 + TLS 1)**

---

## ğŸ”¹ TLS 1.3 with 0-RTT (Session Resumption)

**TCP å»ºç«‹ + TLS**
- **A.** Client â†’ Server : `SYN + ClientHello (+ KeyShare) + 0-RTT Application Data (HTTP GET â€¦)`  
- **B.** Server â†’ Client : `SYN+ACK + ServerHello (+ å¯é¸ early response)`  
- **C.** Client â†’ Server : `ACK`  
- **D.** Server â†’ Client : `EncryptedExtensions + Certificate + Finished + Encrypted Application Data (HTTP Response â€¦)`  
- **E.** Client â†’ Server : `Finished`

â¡ï¸ **åªéœ€ 1 RTT å°±èƒ½æ‹¿åˆ°ç¬¬ä¸€å€‹ Response**  
ï¼ˆ0-RTT è³‡æ–™ç¼ºä¹å‰å‘å®‰å…¨æ€§ï¼Œå¯èƒ½è¢«é‡æ”¾æ”»æ“Šï¼‰

---

# ğŸ”¹ å·®ç•°æ¯”è¼ƒè¡¨

| å”è­°ç‰ˆæœ¬       | TLS æ¡æ‰‹æ‰€éœ€ RTT | å¯ä»¥çœç•¥ / ç–Šåˆçš„è¨Šæ¯ |
|----------------|------------------|------------------------|
| TLS 1.2        | 2 RTT            | ç„¡ï¼ˆæ¯æ®µç¨ç«‹ï¼‰        |
| TLS 1.3        | 1 RTT            | ServerHello + Certificate + Finished åˆä½µï¼›ClientKeyExchange & Finished åˆä½µ |
| TLS 1.3 0-RTT  | 0 RTT (æ‡‰ç”¨å±¤) + 1 RTTï¼ˆç¢ºèªå®Œæˆï¼‰ | ClientHello èˆ‡ Application Data ç–Šåˆï¼›ServerHello èˆ‡ Application Response ç–Šåˆ |

# TLS æ¡æ‰‹èˆ‡åŠ å¯†æµç¨‹è§£æ

## 1ï¸âƒ£ éå°ç¨±åŠ å¯†ï¼šå…¬é‘°èˆ‡ç§é‘°

TLS æ¡æ‰‹åˆæœŸä½¿ç”¨ **éå°ç¨±åŠ å¯†**ï¼Œç›®çš„ï¼š
1. èº«ä»½é©—è­‰ï¼šServer é€é Certificate (å…¬é‘°ç°½ç« ) è®“ Client é©—è­‰
2. å®‰å…¨äº¤æ›å°ç¨±å¯†é‘°ï¼šé¿å…ä¸­é–“äººç«Šè½

### å°æ‡‰æµç¨‹
- **E. Server â†’ Client : Certificate + ServerKeyExchange**
  - Server å‚³å…¬é‘° (Certificate)
  - ServerKeyExchange æä¾› ECDHE å…¬é‘°
- **F. Client â†’ Server : ClientKeyExchange**
  - Client ä½¿ç”¨ Server å…¬é‘°/ ECDHE è¨ˆç®— PreMasterSecret
  - Server ç”¨ç§é‘°è¨ˆç®—åŒæ¨£å…±äº«å¯†é‘°

> æ ¸å¿ƒï¼šéå°ç¨±åªç”¨æ–¼å®‰å…¨äº¤æ›å°ç¨±å¯†é‘°

---

## 2ï¸âƒ£ ç”¢ç”Ÿå°ç¨±å¯†é‘° (Session Key)

é›™æ–¹ä½¿ç”¨ï¼š
- Client Random (D)
- Server Random (E)
- PreMasterSecret (F)

é€é **Key Derivation Function (KDF)** è¨ˆç®—ï¼š
- Master Secret â†’ Session Key
- Session Key ç”¨æ–¼å°ç¨±åŠ å¯†ï¼ˆAES, ChaCha20â€¦ï¼‰

> æ ¸å¿ƒï¼šå®‰å…¨äº¤æ›å°ç§˜å¯† â†’ ç”Ÿæˆå¤§ç§˜å¯† â†’ å°ç¨±é«˜é€ŸåŠ å¯†

---

## 3ï¸âƒ£ æ¡æ‰‹å¾Œåˆ‡æ›å°ç¨±åŠ å¯†

- **F. Client â†’ Server : ChangeCipherSpec + Finished**
  - Client é€šçŸ¥ Server å¾æ­¤ä½¿ç”¨å°ç¨±å¯†é‘°åŠ å¯†
- **G. Server â†’ Client : ChangeCipherSpec + Finished**
  - Server åŒæ­¥åˆ‡æ›åˆ°å°ç¨±å¯†é‘°

> ç¾åœ¨é›™æ–¹æ¡åˆ°ç›¸åŒçš„ Session Keyï¼Œé–‹å§‹é«˜é€Ÿå°ç¨±åŠ å¯†é€šè¨Š

---

## 4ï¸âƒ£ æ‡‰ç”¨å±¤è³‡æ–™åŠ è§£å¯†

- **H/I. Encrypted Application Data**
  - å°ç¨±åŠ å¯†å¥—ç”¨æ–¼ HTTP è³‡æ–™
  - Cipher Suite æ±ºå®šåŠ å¯†ç®—æ³•ï¼Œä¾‹å¦‚ï¼š
    - AES-GCM / ChaCha20-Poly1305 (åŠ å¯† + å®Œæ•´æ€§é©—è­‰)
  - Client/Server ä½¿ç”¨ Session Key åšåŠ è§£å¯†
  - ä¸­é–“äººç„¡æ³•è§£å¯†è³‡æ–™

---

## ğŸ”¹ ç¸½çµæµç¨‹å°æ‡‰è¡¨

| æµç¨‹ç·¨è™Ÿ | åŠŸèƒ½                       | åŠ å¯†é¡å‹       | è¨Šæ¯å…§å®¹                                     |
|-----------|---------------------------|----------------|---------------------------------------------|
| D ClientHello | æ¡æ‰‹é–‹å§‹                 | ç„¡             | Cipher Suite, TLS ç‰ˆæœ¬, Client Random       |
| E ServerHello + Certificate + ServerKeyExchange | æ¡æ‰‹å›æ‡‰ã€èº«ä»½é©—è­‰ | éå°ç¨±         | Server Random, Server å…¬é‘° / KeyExchange   |
| F ClientKeyExchange + ChangeCipherSpec + Finished | ç”Ÿæˆå…±äº«å¯†é‘°ã€åˆ‡æ›å°ç¨±åŠ å¯† | éå°ç¨± â†’ å°ç¨± | PreMasterSecret â†’ Session Key, æ›å°ç¨±å¯†é‘° |
| G ChangeCipherSpec + Finished | åˆ‡æ›åŠ å¯†              | å°ç¨±           | Session Key é–‹å§‹ä½¿ç”¨                         |
| H/I Application Data | æ‡‰ç”¨å±¤è³‡æ–™åŠ å¯†         | å°ç¨±           | HTTP GET / Responseï¼ŒåŠ å¯†å¾Œå‚³è¼¸             |
