---
title: "Linux: Process"
description: 一些關於 Linux Process 的隨手記，想到什麼整理什麼
date: 2025-07-24 12:00:00 +0800
categories: [Careers, Linux]
tags: [Tech, Linux]
---

在 Linux 中使用 `struct task_struct` 來管理 process 和 thread，完整結構超過 800 行程式碼，僅在此列出本頁提及的相關項目

```c
struct task_struct {
    // ...
    pid_t pid;
    pid_t tgid;
    // ...
    struct mm_struct *mm;
    // ...
    struct fs_struct *fs;
    // ...
};
```
{: file='linux/include/linux/sched.h'}

每個 thread 會擁有一個只屬於自己的 `pid`，並且屬於同一個 process 的 thread 會共用同一個 `tgid`

每個 process 會有一個 main thread，並且使用 main thread 的 `task_struct` 代表這個 process，他的 `pid = tgid`

>`getpid()` 會回傳 `tgid`，`gettid()` 會回傳 `pid`
{: .prompt-info }

為了方便理解，我一律使用 pid 代表 getpid()，tid 代表 gettid()

### `/proc/`

檔案系統中有個目錄 `/proc/<pid>` 專門用來輸出各種和該 `pid` 的 `process` 相關的資訊，會把很多 `task_struct` 內的資訊經過整理放在這裡，只要能理解這個目錄底下的資訊，我們就可以很大程度的了解這個 `process`，最好的是這個方法幾乎不需要任何困難技術就可以觀察到 `task_struct`

要記得使用 `root` 權限來操作，這裡有很多東西都是限制 `root user` 才能操作的

```
harvey@LAPTOP-HARVEY:/proc/1$ sudo su
root@LAPTOP-HARVEY:/proc/1# ls
arch_status      exe                maps           pagemap       stack
attr             fd                 mem            patch_state   stat
auxv             fdinfo             mountinfo      personality   statm
cgroup           gid_map            mounts         projid_map    status
clear_refs       io                 mountstats     root          syscall
cmdline          ksm_merging_pages  net            sched         task
comm             ksm_stat           ns             schedstat     timens_offsets
coredump_filter  latency            numa_maps      sessionid     timers
cpuset           limits             oom_adj        setgroups     timerslack_ns
cwd              loginuid           oom_score      smaps         uid_map
environ          map_files          oom_score_adj  smaps_rollup  wchan
```

當然可以 `sudo ls`，但接下來要往內看細節時也會一直需要 `root` 權限，遇到目錄時甚至沒辦法 `sudo cd` 來進入，因此推薦直接使用 `root` 來操作

這些大部分的內容其實不是真的檔案，是當我們 access 的時候由 kernel 動態生成的虛擬檔案系統（Virtual Filesystem, VFS）

```
root@LAPTOP-HARVEY:/proc/1# ls -l | grep ^d
dr-xr-xr-x  2 root root  0 Aug  9 21:23 attr
dr-x------  2 root root 66 Aug  9 21:23 fd
dr-xr-xr-x  2 root root  0 Aug 10 03:04 fdinfo
dr-x------  2 root root  0 Aug 10 03:04 map_files
dr-xr-xr-x 57 root root  0 Aug  9 21:23 net
dr-x--x--x  2 root root  0 Aug 10 03:04 ns
dr-xr-xr-x  3 root root  0 Aug 10 03:04 task

```


再次強調他們可能不是真正存在於硬碟的檔案，而是在我們觀測的時候生成的臨時檔案，接下來我會整理 `/proc/<pid>` 裡面的各項目的意義﹑生成的函數 (來自 `fs/proc/base.c`)﹑以及對應 `task_struct` 的來源


### 符號連結

在 linux 中有些檔案會以 `l` 開頭，它們代表的是一個指向其他路徑的符號連結（symlink），對這些項目使用 `readlink` 可以看到他們指向的目標，`/proc/<pid>/` 底下也有幾個

```
root@LAPTOP-HARVEY:/proc/1# ls -l | grep ^l
lrwxrwxrwx  1 root root  0 Aug  9 21:23 cwd -> /
lrwxrwxrwx  1 root root  0 Aug  9 21:23 exe -> /usr/lib/systemd/systemd
lrwxrwxrwx  1 root root  0 Aug  9 21:23 root -> /

root@LAPTOP-HARVEY:/proc/1# readlink exe
/usr/lib/systemd/systemd
```

| Name         | Access Function         | Target `task_struct task;`       | Meaning                                     |
| :----------- | :---------------------- | :------------------------------- | :------------------------------------------ |
| `cwd`        | `proc_cwd_link()`       | `task->fs->pwd`                  | Current working directory                   |
| `exe`        | `proc_exe_link()`       | `task->mm->exe_file`             | Executable file path                        |
| `root`       | `proc_root_link()`      | `task->fs->root`                 | Root directory for this process's namespace |


```c
struct fs_struct {
    int users;
    seqlock_t seq;
    int umask;
    int in_exec;
    struct path root, pwd;
} __randomize_layout;
```
{: file='linux/include/linux/fs_struct.h'}

```c
struct mm_struct {
    // ...
        struct file __rcu *exe_file;
    // ...
};
```
{: file='linux/include/linux/mm_types.h'}


> 尚未完成，以下內容未整理
{: .prompt-warning }

| Name             | Access Function               | Target `task_struct task;` / Related Structure        | Meaning                                                        |
| :--------------- | :----------------------------| :---------------------------------------------------- | :-------------------------------------------------------------|
| `fd`             | `proc_fd_readdir()` / `proc_fd_lookup()` | `task->files->fdt`                             | File descriptor table (open files)                              |
| `fdinfo`         | `proc_fdinfo_readdir()` / `proc_fdinfo_lookup()` | `task->files->fdt`                          | Detailed info per open file descriptor                          |
| `maps`           | `proc_pid_maps_operations`    | `task->mm->mmap`                                      | Memory mappings of the process                                  |
| `map_files`      | `proc_pid_map_files()`         | `task->mm->mmap`                                      | Files backing the memory mappings                               |
| `mem`            | `proc_mem_operations`          | `task->mm`                                            | Access to process memory                                        |
| `pagemap`        | `proc_pagemap_operations`      | `task->mm`                                            | Page mapping information                                       |
| `stack`          | `proc_pid_stack()`             | `task->stack`                                        | Kernel stack trace of the task                                  |
| `stat`           | `proc_tid_stat()`              | Various `task_struct` fields                           | Process and thread statistics                                  |
| `statm`          | `proc_pid_statm()`             | `task->mm`                                            | Process memory usage summary                                   |
| `status`         | `proc_pid_status()`            | Various `task_struct` fields                           | Detailed process status                                        |
| `cmdline`        | `proc_pid_cmdline_ops`         | `task->mm->arg_start` and `arg_end`                   | Command line arguments                                         |
| `environ`        | `proc_environ_operations`      | `task->mm->env_start` and `env_end`                   | Environment variables                                         |
| `auxv`           | `proc_auxv_operations`         | `task->mm->env_end`                                   | Auxiliary vector entries                                      |
| `comm`           | `proc_tid_comm_inode_operations` | `task->comm`                                        | Command name (short process name)                             |
| `oom_score`      | `proc_oom_score`               | `task->signal->oom_score`                             | Out-of-memory killer score                                    |
| `oom_adj`        | `proc_oom_adj_operations`      | `task->signal->oom_score_adj`                         | Adjust oom score                                              |
| `oom_score_adj`  | `proc_oom_score_adj_operations`| `task->signal->oom_score_adj`                         | Adjust oom score (new interface)                             |
| `limits`         | `proc_pid_limits()`             | Resource limits in `task->signal->rlim`               | Process resource limits                                      |
| `loginuid`       | `proc_loginuid_operations`      | `task->loginuid`                                      | Login user ID                                                |
| `sessionid`      | `proc_sessionid_operations`     | `task->sessionid`                                     | Session ID                                                  |
| `personality`    | `proc_pid_personality()`        | `task->personality`                                   | Process personality (execution domain)                       |
| `sched`          | `proc_pid_sched_operations`     | Scheduling info in `task_struct`                      | Scheduling parameters and statistics                         |
| `schedstat`      | `proc_pid_schedstat()`          | Scheduling stats                                       | Per-process scheduling statistics                            |
| `latency`        | `proc_lstats_operations`        | Latency information                                   | Latency monitoring                                           |
| `io`             | `proc_tid_io_accounting()`      | I/O accounting info                                   | Task I/O statistics                                          |
| `ns`             | `proc_ns_dir_operations`        | Various `task_struct` namespace fields                | Namespaces of the task                                       |
| `net`            | `proc_net_operations`           | Network info related to the process                   | Network namespace info                                      |
| `cgroup`         | `proc_cgroup_show()`            | `task->cgroups`                                      | Control group membership                                    |
| `cpuset`         | `proc_cpuset_show()`            | CPU sets                                              | CPU affinity settings                                       |
| `mounts`         | `proc_mounts_operations`        | Mount points from `task->fs->root`                     | Mounted filesystems                                         |
| `mountinfo`      | `proc_mountinfo_operations`     | Detailed mount info                                   | Mount namespace info                                       |
| `clear_refs`     | `proc_clear_refs_operations`    | Page monitoring flags                                | Clear page reference bits                                  |
| `smaps`          | `proc_pid_smaps_operations`     | Memory usage details                                 | Extended memory info                                       |
| `smaps_rollup`   | `proc_pid_smaps_rollup_operations` | Aggregated smaps                                    | Aggregated memory info                                    |
| `ksm_merging_pages` | `proc_pid_ksm_merging_pages`  | Kernel samepage merging info                          | KSM pages info                                            |
| `ksm_stat`       | `proc_pid_ksm_stat`             | KSM statistics                                       | Kernel samepage merging stats                             |
| `uid_map`        | `proc_uid_map_operations`       | User namespace mappings                              | User ID namespace maps                                    |
| `gid_map`        | `proc_gid_map_operations`       | Group namespace mappings                             | Group ID namespace maps                                   |
| `projid_map`     | `proc_projid_map_operations`    | Project ID mappings                                  | Project ID namespace maps                                |
| `setgroups`      | `proc_setgroups_operations`     | Setgroups configuration                             | Controls group setgroups                                  |
| `sessionid`      | `proc_sessionid_operations`     | Session ID                                          | Process session ID                                       |
| `personality`    | `proc_pid_personality`           | Personality flags                                   | Process personality                                     |
| `syscall`        | `proc_pid_syscall`               | Current syscall number                              | Syscall being executed                                  |
| `timers`         | `proc_timers_operations`         | Task timers                                        | Timers used by the process                             |
| `timens_offsets` | `proc_timens_offsets_operations`| Time namespace offsets                             | Time namespace data                                   |
| `wchan`          | `proc_pid_wchan`                 | Wait channel                                       | Kernel function where task is sleeping                 |
| `patch_state`    | `proc_pid_patch_state`           | Livepatch state                                   | Livepatch applied state                               |
| `latency`        | `proc_lstats_operations`         | Latency statistics                                | Latency monitoring                                    |

