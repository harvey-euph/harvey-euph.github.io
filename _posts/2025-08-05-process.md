---
title: "Linux: Process"
description: 一些關於 Linux Process 的隨手記，想到什麼整理什麼
date: 2025-07-24 12:00:00 +0800
categories: [Careers, Linux]
tags: [Tech, Linux]
---

在 Linux 中使用 `struct task_struct` 來管理 process 和 thread，完整結構超過 800 行程式碼，僅在此列出本頁提及的相關項目

```c
struct task_struct {
    // ...
    pid_t pid;
    pid_t tgid;
    // ...
    struct mm_struct *mm;
    // ...
    struct fs_struct *fs;
    // ...
};
```
{: file='linux/include/linux/sched.h'}

每個 `thread` 會擁有一個只屬於自己的 `pid`，並且屬於同一個 `process` 的 `thread` 會共用同一個 `tgid`，通常也會共用 `fs` 和 `mm`

每個 `process` 會有一個 `main thread`，並且使用 `main thread` 的 `task_struct` 代表這個 `process`，他的 `pid = tgid`

從現在起 `struct task_struct *task;`

>`getpid()` 會回傳 `task->tgid`，`gettid()` 會回傳 `task->pid`
{: .prompt-info }

為了方便理解，我一律使用 `pid` 代表 `getpid()`，`tid` 代表 `gettid()`

檔案系統中有個目錄 `/proc/<pid>` 專門用來輸出各種和該 `pid` 的 `process` 相關的資訊，會把很多 `task_struct` 內的資訊經過整理放在這裡，透過這個目錄底下的資訊，我們就能很大程度了解這個 `process`，最好的是這個方法幾乎不需要任何困難技術就可以觀察到 `task_struct`

要記得使用 `root` 權限來操作，這裡有很多東西都是限制 `root` 才能操作的

```
harvey@LAPTOP-HARVEY:/proc/1$ sudo su
root@LAPTOP-HARVEY:/proc/1# ls
arch_status      exe                maps           pagemap       stack
attr             fd                 mem            patch_state   stat
auxv             fdinfo             mountinfo      personality   statm
cgroup           gid_map            mounts         projid_map    status
clear_refs       io                 mountstats     root          syscall
cmdline          ksm_merging_pages  net            sched         task
comm             ksm_stat           ns             schedstat     timens_offsets
coredump_filter  latency            numa_maps      sessionid     timers
cpuset           limits             oom_adj        setgroups     timerslack_ns
cwd              loginuid           oom_score      smaps         uid_map
environ          map_files          oom_score_adj  smaps_rollup  wchan
```

當然可以 `sudo ls`，但接下來要往內看細節時也會一直需要 `root` 權限，遇到目錄時甚至沒辦法 `sudo cd` 來進入，因此推薦直接使用 `root` 來操作

這些大部分的內容其實不是真的檔案，是當我們 access 的時候由 kernel 動態生成的虛擬檔案系統 `(Virtual Filesystem, VFS)`

接下來我會整理 `/proc/<pid>` 裡面的各項目的意義﹑生成這些檔案的函數 (來自 `fs/proc/base.c`)﹑以及對應 `task_struct` 的來源


### 符號連結

在 linux 中有些檔案代表的是一個指向其他路徑的符號連結 `(symlink)`，對這些項目使用 `readlink` 可以看到他們指向的目標

`/proc/<pid>/` 裡面也有這種檔案

```
root@LAPTOP-HARVEY:/proc/1# ls -l | grep ^l
lrwxrwxrwx  1 root root  0 Aug  9 21:23 cwd -> /
lrwxrwxrwx  1 root root  0 Aug  9 21:23 exe -> /usr/lib/systemd/systemd
lrwxrwxrwx  1 root root  0 Aug  9 21:23 root -> /

root@LAPTOP-HARVEY:/proc/1# readlink exe
/usr/lib/systemd/systemd
```

| 項目         | 呼叫的函數               | 來源                 | 意義                                         |
| :----------- | :---------------------- | :------------------- | :------------------------------------------ |
| `cwd`        | `proc_cwd_link()`       | `task->fs->pwd`      | Current working directory                   |
| `exe`        | `proc_exe_link()`       | `task->mm->exe_file` | Executable file path                        |
| `root`       | `proc_root_link()`      | `task->fs->root`     | Root directory for this process's namespace |

以下附上用到的 `fs` 和 `mm` 內容結構

```c
struct fs_struct {
    int users;
    seqlock_t seq;
    int umask;
    int in_exec;
    struct path root, pwd;
} __randomize_layout;
```
{: file='linux/include/linux/fs_struct.h'}

```c
struct mm_struct {
    // ...
        struct file __rcu *exe_file;
    // ...
};
```
{: file='linux/include/linux/mm_types.h'}

## Directories

```
root@LAPTOP-HARVEY:/proc/76# ls -l | grep ^d
dr-xr-xr-x  2 root root 0 Aug 10 14:47 attr
dr-x------  2 root root 7 Aug  9 21:23 fd
dr-xr-xr-x  2 root root 0 Aug 10 14:47 fdinfo
dr-x------  2 root root 0 Aug 10 14:47 map_files
dr-xr-xr-x 57 root root 0 Aug 10 14:47 net
dr-x--x--x  2 root root 0 Aug 10 14:47 ns
dr-xr-xr-x  5 root root 0 Aug 10 14:47 task
```

### task

在 `/proc/<pid>/task/` 裡面的每個項目都是以數字命名的資料夾，代表著這個 `process` 底下的每個 `threads`，有幾個 `threads` 就會有幾個資料夾，名字就是他的 `tid`

```
root@LAPTOP-HARVEY:/proc/76/task# ls -l
total 0
dr-xr-xr-x 7 root root 0 Aug 10 17:01 76
dr-xr-xr-x 7 root root 0 Aug 10 17:01 78
dr-xr-xr-x 7 root root 0 Aug 10 17:01 79
```

再進到任意一個資料夾 (例如 `78`) 會發現 `/proc/<pid>/` 和 `/proc/<pid>/task/<tid>` 長得非常像，我也還沒仔細研究到底關係是什麼，但大致上 `/proc/<pid>/` 就是裡面 `/proc/<pid>/task/<tid>` 的統合資料，`/proc/<pid>/task/<tid>` 則是各自 `thread` 自己的資料

```
root@LAPTOP-HARVEY:/proc/76/task/78# ls
arch_status  environ            loginuid   oom_score_adj  smaps
attr         exe                maps       pagemap        smaps_rollup
auxv         fd                 mem        patch_state    stack
cgroup       fdinfo             mountinfo  personality    stat
children     gid_map            mounts     projid_map     statm
clear_refs   io                 net        root           status
cmdline      ksm_merging_pages  ns         sched          syscall
comm         ksm_stat           numa_maps  schedstat      uid_map
cpuset       latency            oom_adj    sessionid      wchan
cwd          limits             oom_score  setgroups
```

比對了一下發現比起 `/proc/<pid>/` 少了以下項目: `coredump_filter map_files mountstats task timens_offsets timers timerslack_ns`
少了 `task` 很合理，還要再研究其他的意義

### fd 和 fdinfo

```
root@LAPTOP-HARVEY:/proc/65# ls -l fd
total 0
lr-x------ 1 root root 64 Aug 10 17:39 0 -> /dev/null
lrwx------ 1 root root 64 Aug 10 17:39 1 -> 'socket:[12310]'
lrwx------ 1 root root 64 Aug 10 17:39 10 -> 'anon_inode:[signalfd]'
lrwx------ 1 root root 64 Aug 10 17:39 11 -> 'anon_inode:[timerfd]'
lr-x------ 1 root root 64 Aug 10 17:39 12 -> /usr/lib/udev/hwdb.bin
lrwx------ 1 root root 64 Aug  9 21:23 13 -> 'anon_inode:[timerfd]'
lrwx------ 1 root root 64 Aug 10 17:39 2 -> 'socket:[12310]'
lrwx------ 1 root root 64 Aug  9 21:23 3 -> 'socket:[7229]'
lrwx------ 1 root root 64 Aug  9 21:23 4 -> 'socket:[7231]'
lrwx------ 1 root root 64 Aug 10 17:39 5 -> 'socket:[1990]'
lrwx------ 1 root root 64 Aug 10 17:39 6 -> 'socket:[1992]'
lrwx------ 1 root root 64 Aug 10 17:39 7 -> 'socket:[1993]'
lr-x------ 1 root root 64 Aug 10 17:39 8 -> anon_inode:inotify
lrwx------ 1 root root 64 Aug 10 17:39 9 -> 'anon_inode:[eventpoll]'
```

```
root@LAPTOP-HARVEY:/proc/65# ls -l fdinfo/
total 0
-r--r--r-- 1 root root 0 Aug 10 17:39 0
-r--r--r-- 1 root root 0 Aug 10 17:39 1
-r--r--r-- 1 root root 0 Aug 10 17:39 10
-r--r--r-- 1 root root 0 Aug 10 17:39 11
-r--r--r-- 1 root root 0 Aug 10 17:39 12
-r--r--r-- 1 root root 0 Aug 10 17:39 13
-r--r--r-- 1 root root 0 Aug 10 17:39 2
-r--r--r-- 1 root root 0 Aug 10 17:39 3
-r--r--r-- 1 root root 0 Aug 10 17:39 4
-r--r--r-- 1 root root 0 Aug 10 17:39 5
-r--r--r-- 1 root root 0 Aug 10 17:39 6
-r--r--r-- 1 root root 0 Aug 10 17:39 7
-r--r--r-- 1 root root 0 Aug 10 17:39 8
-r--r--r-- 1 root root 0 Aug 10 17:39 9
```

```
root@LAPTOP-HARVEY:/proc/65# cat fdinfo/1
pos:    0
flags:  02
mnt_id: 9
ino:    12310
scm_fds: 0
```

### map_files and maps

它們其實是差不多的內容，但有一點細微差異
- `map_files`: 整理出指向對應檔案的 `symlink`，方便程式操作
- `maps`: 以純文字列出該 `process` 的記憶體映射區段，方便閱讀

```
root@LAPTOP-HARVEY:/proc/287/map_files# ls -l
total 0
lr-------- 1 root root 64 Aug 10 17:18 5912f9abf000-5912f9ac2000 -> /usr/sbin/agetty
lr-------- 1 root root 64 Aug 10 17:18 5912f9ac2000-5912f9ac9000 -> /usr/sbin/agetty
lr-------- 1 root root 64 Aug 10 17:18 5912f9ac9000-5912f9acb000 -> /usr/sbin/agetty
lr-------- 1 root root 64 Aug 10 17:18 5912f9acc000-5912f9acd000 -> /usr/sbin/agetty
lr-------- 1 root root 64 Aug 10 17:18 5912f9acd000-5912f9ace000 -> /usr/sbin/agetty
lr-------- 1 root root 64 Aug 10 17:18 7cc76d400000-7cc76d428000 -> /usr/lib/x86_64-linux-gnu/libc.so.6
lr-------- 1 root root 64 Aug 10 17:18 7cc76d428000-7cc76d5bd000 -> /usr/lib/x86_64-linux-gnu/libc.so.6
lr-------- 1 root root 64 Aug 10 17:18 7cc76d5bd000-7cc76d615000 -> /usr/lib/x86_64-linux-gnu/libc.so.6
lr-------- 1 root root 64 Aug 10 17:18 7cc76d615000-7cc76d616000 -> /usr/lib/x86_64-linux-gnu/libc.so.6
lr-------- 1 root root 64 Aug 10 17:18 7cc76d616000-7cc76d61a000 -> /usr/lib/x86_64-linux-gnu/libc.so.6
lr-------- 1 root root 64 Aug 10 17:18 7cc76d61a000-7cc76d61c000 -> /usr/lib/x86_64-linux-gnu/libc.so.6
lr-------- 1 root root 64 Aug 10 17:18 7cc76d6b2000-7cc76d709000 -> /usr/lib/locale/C.utf8/LC_CTYPE
lr-------- 1 root root 64 Aug 10 17:18 7cc76d70f000-7cc76d716000 -> /usr/lib/x86_64-linux-gnu/gconv/gconv-modules.cache
lr-------- 1 root root 64 Aug 10 17:18 7cc76d718000-7cc76d71a000 -> /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
lr-------- 1 root root 64 Aug 10 17:18 7cc76d71a000-7cc76d744000 -> /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
lr-------- 1 root root 64 Aug 10 17:18 7cc76d744000-7cc76d74f000 -> /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
lr-------- 1 root root 64 Aug 10 17:18 7cc76d750000-7cc76d752000 -> /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
lr-------- 1 root root 64 Aug 10 17:18 7cc76d752000-7cc76d754000 -> /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
```

```
root@LAPTOP-HARVEY:/proc/287# cat maps
5912f9abf000-5912f9ac2000 r--p 00000000 08:30 17375                      /usr/sbin/agetty
5912f9ac2000-5912f9ac9000 r-xp 00003000 08:30 17375                      /usr/sbin/agetty
5912f9ac9000-5912f9acb000 r--p 0000a000 08:30 17375                      /usr/sbin/agetty
5912f9acc000-5912f9acd000 r--p 0000c000 08:30 17375                      /usr/sbin/agetty
5912f9acd000-5912f9ace000 rw-p 0000d000 08:30 17375                      /usr/sbin/agetty
5912f9ace000-5912f9ad0000 rw-p 00000000 00:00 0
591309bbd000-591309bde000 rw-p 00000000 00:00 0                          [heap]
7cc76d400000-7cc76d428000 r--p 00000000 08:30 114531                     /usr/lib/x86_64-linux-gnu/libc.so.6
7cc76d428000-7cc76d5bd000 r-xp 00028000 08:30 114531                     /usr/lib/x86_64-linux-gnu/libc.so.6
7cc76d5bd000-7cc76d615000 r--p 001bd000 08:30 114531                     /usr/lib/x86_64-linux-gnu/libc.so.6
7cc76d615000-7cc76d616000 ---p 00215000 08:30 114531                     /usr/lib/x86_64-linux-gnu/libc.so.6
7cc76d616000-7cc76d61a000 r--p 00215000 08:30 114531                     /usr/lib/x86_64-linux-gnu/libc.so.6
7cc76d61a000-7cc76d61c000 rw-p 00219000 08:30 114531                     /usr/lib/x86_64-linux-gnu/libc.so.6
7cc76d61c000-7cc76d629000 rw-p 00000000 00:00 0
7cc76d6b2000-7cc76d709000 r--p 00000000 08:30 113992                     /usr/lib/locale/C.utf8/LC_CTYPE
7cc76d709000-7cc76d70c000 rw-p 00000000 00:00 0
7cc76d70f000-7cc76d716000 r--s 00000000 08:30 154117                     /usr/lib/x86_64-linux-gnu/gconv/gconv-modules.cache
7cc76d716000-7cc76d718000 rw-p 00000000 00:00 0
7cc76d718000-7cc76d71a000 r--p 00000000 08:30 114515                     /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
7cc76d71a000-7cc76d744000 r-xp 00002000 08:30 114515                     /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
7cc76d744000-7cc76d74f000 r--p 0002c000 08:30 114515                     /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
7cc76d750000-7cc76d752000 r--p 00037000 08:30 114515                     /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
7cc76d752000-7cc76d754000 rw-p 00039000 08:30 114515                     /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
7ffeb9c4b000-7ffeb9c6c000 rw-p 00000000 00:00 0                          [stack]
7ffeb9ddc000-7ffeb9de0000 r--p 00000000 00:00 0                          [vvar]
7ffeb9de0000-7ffeb9de2000 r-xp 00000000 00:00 0                          [vdso]
```

> 尚未完成，以下內容未整理
{: .prompt-warning }

| Name             | Access Function               | Target / Related Structure        | Meaning                                                        |
| :--------------- | :----------------------------| :---------------------------------------------------- | :-------------------------------------------------------------|
| `fd`             | `proc_fd_readdir()`<br>`proc_fd_lookup()` | `task->files->fdt`                             | File descriptor table (open files)                              |
| `fdinfo`         | `proc_fdinfo_readdir()`<br>`proc_fdinfo_lookup()` | `task->files->fdt`                          | Detailed info per open file descriptor                          |
| `maps`           | `proc_pid_maps_operations`    | `task->mm->mmap`                                      | Memory mappings of the process                                  |
| `map_files`      | `proc_pid_map_files()`         | `task->mm->mmap`                                      | Files backing the memory mappings                               |
| `mem`            | `proc_mem_operations`          | `task->mm`                                            | Access to process memory                                        |
| `pagemap`        | `proc_pagemap_operations`      | `task->mm`                                            | Page mapping information                                       |
| `stack`          | `proc_pid_stack()`             | `task->stack`                                        | Kernel stack trace of the task                                  |
| `stat`           | `proc_tid_stat()`              | Various `task_struct` fields                           | Process and thread statistics                                  |
| `statm`          | `proc_pid_statm()`             | `task->mm`                                            | Process memory usage summary                                   |
| `status`         | `proc_pid_status()`            | Various `task_struct` fields                           | Detailed process status                                        |
| `cmdline`        | `proc_pid_cmdline_ops`         | `task->mm->arg_start` and `arg_end`                   | Command line arguments                                         |
| `environ`        | `proc_environ_operations`      | `task->mm->env_start` and `env_end`                   | Environment variables                                         |
| `auxv`           | `proc_auxv_operations`         | `task->mm->env_end`                                   | Auxiliary vector entries                                      |
| `comm`           | `proc_tid_comm_inode_operations` | `task->comm`                                        | Command name (short process name)                             |
| `oom_score`      | `proc_oom_score`               | `task->signal->oom_score`                             | Out-of-memory killer score                                    |
| `oom_adj`        | `proc_oom_adj_operations`      | `task->signal->oom_score_adj`                         | Adjust oom score                                              |
| `oom_score_adj`  | `proc_oom_score_adj_operations`| `task->signal->oom_score_adj`                         | Adjust oom score (new interface)                             |
| `limits`         | `proc_pid_limits()`             | Resource limits in `task->signal->rlim`               | Process resource limits                                      |
| `loginuid`       | `proc_loginuid_operations`      | `task->loginuid`                                      | Login user ID                                                |
| `sessionid`      | `proc_sessionid_operations`     | `task->sessionid`                                     | Session ID                                                  |
| `personality`    | `proc_pid_personality()`        | `task->personality`                                   | Process personality (execution domain)                       |
| `sched`          | `proc_pid_sched_operations`     | Scheduling info in `task_struct`                      | Scheduling parameters and statistics                         |
| `schedstat`      | `proc_pid_schedstat()`          | Scheduling stats                                       | Per-process scheduling statistics                            |
| `latency`        | `proc_lstats_operations`        | Latency information                                   | Latency monitoring                                           |
| `io`             | `proc_tid_io_accounting()`      | I/O accounting info                                   | Task I/O statistics                                          |
| `ns`             | `proc_ns_dir_operations`        | Various `task_struct` namespace fields                | Namespaces of the task                                       |
| `net`            | `proc_net_operations`           | Network info related to the process                   | Network namespace info                                      |
| `cgroup`         | `proc_cgroup_show()`            | `task->cgroups`                                      | Control group membership                                    |
| `cpuset`         | `proc_cpuset_show()`            | CPU sets                                              | CPU affinity settings                                       |
| `mounts`         | `proc_mounts_operations`        | Mount points from `task->fs->root`                     | Mounted filesystems                                         |
| `mountinfo`      | `proc_mountinfo_operations`     | Detailed mount info                                   | Mount namespace info                                       |
| `clear_refs`     | `proc_clear_refs_operations`    | Page monitoring flags                                | Clear page reference bits                                  |
| `smaps`          | `proc_pid_smaps_operations`     | Memory usage details                                 | Extended memory info                                       |
| `smaps_rollup`   | `proc_pid_smaps_rollup_operations` | Aggregated smaps                                    | Aggregated memory info                                    |
| `ksm_merging_pages` | `proc_pid_ksm_merging_pages`  | Kernel samepage merging info                          | KSM pages info                                            |
| `ksm_stat`       | `proc_pid_ksm_stat`             | KSM statistics                                       | Kernel samepage merging stats                             |
| `uid_map`        | `proc_uid_map_operations`       | User namespace mappings                              | User ID namespace maps                                    |
| `gid_map`        | `proc_gid_map_operations`       | Group namespace mappings                             | Group ID namespace maps                                   |
| `projid_map`     | `proc_projid_map_operations`    | Project ID mappings                                  | Project ID namespace maps                                |
| `setgroups`      | `proc_setgroups_operations`     | Setgroups configuration                             | Controls group setgroups                                  |
| `sessionid`      | `proc_sessionid_operations`     | Session ID                                          | Process session ID                                       |
| `personality`    | `proc_pid_personality`           | Personality flags                                   | Process personality                                     |
| `syscall`        | `proc_pid_syscall`               | Current syscall number                              | Syscall being executed                                  |
| `timers`         | `proc_timers_operations`         | Task timers                                        | Timers used by the process                             |
| `timens_offsets` | `proc_timens_offsets_operations`| Time namespace offsets                             | Time namespace data                                   |
| `wchan`          | `proc_pid_wchan`                 | Wait channel                                       | Kernel function where task is sleeping                 |
| `patch_state`    | `proc_pid_patch_state`           | Livepatch state                                   | Livepatch applied state                               |
| `latency`        | `proc_lstats_operations`         | Latency statistics                                | Latency monitoring                                    |

